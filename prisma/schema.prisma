generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// 1. User/Borrower
model User {
  id      String @id @default(uuid())
  email   String @unique
  name    String
  loans   Loan[]
}

// 2. Loan Product (Configuration)
model LoanProduct {
  id              Int       @id @default(autoincrement())
  name            String
  interestRate    Decimal   @db.Decimal(6, 4) // e.g., 6 digits total, 4 after the decimal (12.3456%)
  termMonths      Int
  loans           Loan[]
}

// 3. Loan (The Contract/State Machine)
model Loan {
  id              String               @id @default(uuid())
  userId          String
  product         LoanProduct          @relation(fields: [productId], references: [id])
  productId       Int
  status          LoanStatus           // Enum: Submitted, Approved, Active, Closed...
  principalAmount Decimal              @db.Decimal(19, 4) // Total amount disbursed
  currentBalance  Decimal              @db.Decimal(19, 4) @default(0.00) // Calculated from transactions
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  version         Int                  @default(1) // For Optimistic Locking (Concurrency control)
  
  user            User                 @relation(fields: [userId], references: [id])
  schedule        AmortizationSchedule[]
  transactions    Transaction[]
}

// 4. Transaction (The Immutable Ledger)
model Transaction {
  id          String         @id @default(uuid())
  loanId      String
  loan        Loan           @relation(fields: [loanId], references: [id])
  type        TransactionType // Enum: DISBURSEMENT, REPAYMENT, INTEREST_ACCRUAL, FEE
  amount      Decimal        @db.Decimal(19, 4) // Amount of money moved
  processedAt DateTime       @default(now())
}

// 5. Amortization Schedule (The Repayment Plan)
model AmortizationSchedule {
  id          Int       @id @default(autoincrement())
  loanId      String
  loan        Loan      @relation(fields: [loanId], references: [id])
  dueDate     DateTime
  principalDue Decimal  @db.Decimal(19, 4)
  interestDue Decimal   @db.Decimal(19, 4)
  isPaid      Boolean   @default(false)
}

// 6. Enums (The State Machine Definitions)
enum LoanStatus {
  DRAFT
  SUBMITTED
  APPROVED
  ACTIVE
  CLOSED
  DEFAULTED
}

enum TransactionType {
  DISBURSEMENT
  REPAYMENT
  INTEREST_ACCRUAL
  FEE
}